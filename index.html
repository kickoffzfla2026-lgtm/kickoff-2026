<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acceso</title>
  <style>
    body{font-family:system-ui,sans-serif;display:flex;min-height:100vh;align-items:center;justify-content:center;background:#f5f6f8;color:#111;padding:24px}
    .wrap{width:min(980px,96vw)}
    .card{width:min(520px,96vw);background:#fff;padding:24px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);margin:0 auto}
    h1{font-size:20px;margin:0 0 12px}
    p{opacity:.9;margin:0 0 10px}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #d7dbe3;background:#fff;color:#111;font-size:16px;outline:none}
    button{width:100%;margin-top:12px;padding:12px 14px;border-radius:12px;border:0;background:#2563eb;color:#fff;font-size:16px;cursor:pointer}
    button:hover{filter:brightness(1.05)}
    .msg{margin-top:12px;min-height:22px;color:#b00020}
    .hint{margin-top:12px;font-size:12px;opacity:.7}

    #gameWrap{display:none;margin:18px auto 0;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:18px}
    .gameTop{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .miniBtn{width:auto;margin:0;padding:10px 12px;border-radius:12px;background:#fff;border:1px solid #d7dbe3;color:#111;cursor:pointer}
    .miniBtn:hover{background:#f5f6f8}

    canvas{width:100%;height:auto;border-radius:16px;background:#ffffff;border:1px solid #d7dbe3;touch-action:manipulation}
    .ok{color:#117a37}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;background:#f1f5ff;border:1px solid #d7dbe3;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- 1) C√ìDIGO -->
    <div class="card" id="codeCard">
      <h1>C√≥digo de Agenteüïµüèª‚Äç‚ôÇÔ∏è</h1>
      <p>Ingresa el c√≥digo para continuar.</p>
      <input id="code" type="password" placeholder="C√≥digo" autocomplete="off" />
      <button id="btn">Entrar</button>
      <div class="msg" id="msg"></div>
      <div class="hint">Si aciertas, recibir√°s una misi√≥n.</div>
    </div>

    <!-- 2) MENSAJE DE MISI√ìN -->
    <div class="card" id="missionCard" style="display:none;">
      <h1>‚úÖ Lograste acceder, agente</h1>
      <p>Ahora tienes una misi√≥n:</p>
      <p><strong>Saltar los obst√°culos.</strong></p>
      <button id="readyBtn">Estoy listo</button>
      <div class="hint">Tip: espacio / clic / toque para saltar.</div>
    </div>

    <!-- 3) JUEGO -->
    <div id="gameWrap">
      <div class="gameTop">
        <div>
          <div style="font-weight:700">Misi√≥n: salta 3 barreras <span class="pill">Espacio / clic / toque</span></div>
          <div class="hint" style="margin:6px 0 0">Si chocas, reinicia.</div>
        </div>
        <button class="miniBtn" id="restartBtn">Reiniciar</button>
      </div>

      <div style="margin-top:12px" class="hint">
        Barreras superadas: <strong><span id="count">0</span>/3</strong>
        <span id="status" style="margin-left:10px"></span>
      </div>

      <div style="margin-top:12px">
        <canvas id="cv" width="900" height="260"></canvas>
      </div>
    </div>

  </div>

  <script>
    // ‚úÖ C√≥digos v√°lidos
    const CODIGOS_VALIDOS = ["2201", "2095", "1883", "0001"];

    // ‚úÖ Enlace Drive a abrir al ganar
    const ENLACE_DRIVE = "https://drive.google.com/file/d/1cfL9S6FOY2NseUfphpPfO4r54i-hxTw0/view?usp=sharing";

    // ====== UI ======
    const codeCard = document.getElementById("codeCard");
    const missionCard = document.getElementById("missionCard");
    const readyBtn = document.getElementById("readyBtn");

    const input = document.getElementById("code");
    const msg = document.getElementById("msg");
    const btn = document.getElementById("btn");

    const gameWrap = document.getElementById("gameWrap");
    const restartBtn = document.getElementById("restartBtn");
    const countEl = document.getElementById("count");
    const statusEl = document.getElementById("status");

    const cv = document.getElementById("cv");
    const ctx = cv.getContext("2d");

    // ====== Abrir Drive grande ======
    function abrirDrivePantallaGrande(){
      const w = screen.width, h = screen.height;
      const features = `toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=${w},height=${h},top=0,left=0`;
      const win = window.open(ENLACE_DRIVE, "_blank", features);
      if (!win) window.location.href = ENLACE_DRIVE;
    }

    // ====== Pantallas ======
    function showMission(){
      codeCard.style.display = "none";
      missionCard.style.display = "block";
    }

    function showGame(){
      missionCard.style.display = "none";
      gameWrap.style.display = "block";
      resetGame();
    }

    // ====== Juego ======
    let running = false;
    let won = false;
    let passed = 0;

    const groundY = 210;
    const gravity = 0.9;

    const spy = {
      x: 120,
      y: groundY,
      w: 34,
      h: 46,
      vy: 0,
      jumping: false
    };

    let speed = 6.8;
    let spawnTimer = 0;
    let nextSpawn = 70;

    const obstacles = [];

    function resetGame(){
      running = true;
      won = false;
      passed = 0;
      speed = 6.8;
      spawnTimer = 0;
      nextSpawn = 70;

      obstacles.length = 0;
      spy.y = groundY;
      spy.vy = 0;
      spy.jumping = false;

      countEl.textContent = "0";
      statusEl.textContent = "";
      statusEl.className = "";
    }

    function jump(){
      if (!running || won) return;
      if (!spy.jumping) {
        spy.vy = -16;
        spy.jumping = true;
      }
    }

    function spawnObstacle(){
      const h = 30 + Math.floor(Math.random()*22);
      obstacles.push({
        x: cv.width + 10,
        y: groundY,
        w: 20 + Math.floor(Math.random()*14),
        h
      });
    }

    function collide(a, b){
      const ax1 = a.x, ax2 = a.x + a.w;
      const ay1 = a.y - a.h, ay2 = a.y;
      const bx1 = b.x, bx2 = b.x + b.w;
      const by1 = b.y - b.h, by2 = b.y;
      return ax1 < bx2 && ax2 > bx1 && ay1 < by2 && ay2 > by1;
    }

    function update(){
      spy.vy += gravity;
      spy.y += spy.vy;

      if (spy.y >= groundY) {
        spy.y = groundY;
        spy.vy = 0;
        spy.jumping = false;
      }

      spawnTimer++;
      if (spawnTimer >= nextSpawn) {
        spawnTimer = 0;
        nextSpawn = 55 + Math.floor(Math.random()*45);
        spawnObstacle();
      }

      for (let i = obstacles.length - 1; i >= 0; i--){
        const o = obstacles[i];
        o.x -= speed;

        if (collide(spy, o)) {
          running = false;
          statusEl.textContent = "Fallaste üòÖ";
          statusEl.className = "";
        }

        if (!o.passed && o.x + o.w < spy.x) {
          o.passed = true;
          passed++;
          countEl.textContent = String(passed);
          speed += 0.28;

          if (passed >= 3 && !won) {
            won = true;
            running = false;
            statusEl.textContent = "¬°Misi√≥n cumplida! ‚úÖ Abriendo‚Ä¶";
            statusEl.className = "ok";
            abrirDrivePantallaGrande();
          }
        }

        if (o.x + o.w < -40) obstacles.splice(i, 1);
      }
    }

    function drawSpy(){
      const x = spy.x, y = spy.y;

      // sombra
      ctx.fillStyle = "rgba(0,0,0,0.08)";
      ctx.beginPath();
      ctx.ellipse(x + spy.w/2, groundY + 10, 18, 4, 0, 0, Math.PI*2);
      ctx.fill();

      // cuerpo (traje)
      ctx.fillStyle = "#111";
      ctx.fillRect(x, y - spy.h, spy.w, spy.h);

      // cabeza
      ctx.fillStyle = "#f2c7a0";
      ctx.fillRect(x + 8, y - spy.h - 18, 18, 18);

      // pelo
      ctx.fillStyle = "#111";
      ctx.fillRect(x + 8, y - spy.h - 18, 18, 6);

      // gafas
      ctx.fillStyle = "#111";
      ctx.fillRect(x + 7, y - spy.h - 10, 20, 6);
      ctx.clearRect(x + 9, y - spy.h - 9, 6, 4);
      ctx.clearRect(x + 19, y - spy.h - 9, 6, 4);

      // corbata
      ctx.fillStyle = "#2563eb";
      ctx.fillRect(x + 16, y - spy.h + 14, 2, 16);

      // piernas
      ctx.fillStyle = "#111";
      ctx.fillRect(x + 5, y - 14, 9, 14);
      ctx.fillRect(x + 20, y - 12, 9, 12);
    }

    function draw(){
      ctx.clearRect(0,0,cv.width,cv.height);

      // fondo blanco
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,cv.width,cv.height);

      // suelo
      ctx.fillStyle = "#111";
      ctx.fillRect(60, groundY, cv.width-120, 3);

      // texto
      ctx.fillStyle = "#111";
      ctx.font = "16px system-ui";
      ctx.fillText("Espacio / clic / toque para saltar", 60, 42);

      // obst√°culos (negros)
      ctx.fillStyle = "#111";
      for (const o of obstacles){
        ctx.fillRect(o.x, o.y - o.h, o.w, o.h);
      }

      drawSpy();
    }

    function loop(){
      if (running) update();
      draw();
      requestAnimationFrame(loop);
    }

    // ====== C√≥digo ‚Üí Misi√≥n ‚Üí Juego ======
    function checkCode(){
      const code = input.value.trim();
      if (CODIGOS_VALIDOS.includes(code)) {
        msg.textContent = "";
        showMission();
      } else {
        msg.textContent = "C√≥digo incorrecto. Intente de nuevo.";
        input.value = "";
        input.focus();
      }
    }

    btn.addEventListener("click", checkCode);
    input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") checkCode(); });
    readyBtn.addEventListener("click", showGame);

    // Controles: espacio, clic, tap
    window.addEventListener("keydown",(e)=>{
      if (e.code === "Space") { e.preventDefault(); jump(); }
    });
    cv.addEventListener("pointerdown",(e)=>{ e.preventDefault(); jump(); });

    restartBtn.addEventListener("click", ()=>{
      statusEl.textContent = "";
      statusEl.className = "";
      resetGame();
    });

    loop();
  </script>
</body>
</html>
